---
title: "ESM 204 HW"
author: "Sam Rozal and Virginia Pan"
date: "4/18/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidyr)
library(here)
library(janitor)
library(lubridate)
library(kableExtra)

```

```{r}
water_districts <- read_csv(here("data", "Water_Districts.csv"))
```
1. For each irrigation district, plot the marginal abatement cost data (from the data provided) and estimate a linear regression model with zero intercept. These estimated linear regressions will be your estimates of the marginal abatement cost curve (one for each irrigation district), which you will use for the remainder of this analysis.

```{r}
#plot abatement for Kern county
ggplot(data=water_districts, aes(x=Reduction, y=MC_Kern))+
  geom_point()+
  labs(x="Reduction",
        y= "Marginal Cost Of Abatement",
       title = "Cost of Abatement in Kern County")+
  theme(legend.background= element_rect(fill= "light blue"))+
  theme(plot.background = element_rect(fill="azure2")) +
  theme(panel.background = element_rect(fill="aliceblue"))
```
```{r}
#Find linear regression model for Kern county 
kern_lm <- lm(MC_Kern ~ 0 + Reduction, data=water_districts)
```
Marginal Cost for Kern County = 2.286A

```{r}
#fitting line for kern 
kern_baseline <- 150
kern_data <- tibble(Reduction = 0:150)
predicted_mc <- predict(kern_lm, newdata=kern_data)
kern_data <- kern_data %>% mutate(predicted_mc=predicted_mc)
```

```{r}
#plotting with predicted line 
ggplot(water_districts, aes(x=Reduction, y=MC_Kern))+
  geom_point()+
  geom_line(data=kern_data, aes(x=Reduction, y=predicted_mc))
```

```{r}
#plot abatement for Mojave county
ggplot(data=water_districts, aes(x=Reduction, y=MC_Mojave))+
  geom_point()+
  labs(x="Reduction",
        y= "Marginal Cost Of Abatement",
       title = "Cost of Abatement in Mojave County")+
  theme(legend.background= element_rect(fill= "light blue"))+
  theme(plot.background = element_rect(fill="azure2")) +
  theme(panel.background = element_rect(fill="aliceblue"))
```

```{r}
#Find linear regression model for Mojave county 
mojave_lm <- lm(MC_Mojave ~ 0 + Reduction, data=water_districts)
mojave_lm_tidy <- broom::tidy(mojave_lm)
summary(mojave_lm)

mojave_lm
```
MC(A) for Mojave County = 3.804A

```{r}
#fitting line for Mojave 
mojave_baseline <- 140
mojave_data <- tibble(Reduction = 0:140)
predicted_mc <- predict(mojave_lm, newdata=mojave_data)
mojave_data <- mojave_data %>% mutate(predicted_mc=predicted_mc)
```

```{r}
#plotting with predicted line 
ggplot(water_districts, aes(x=Reduction, y=MC_Mojave))+
  geom_point()+
  geom_line(data=mojave_data, aes(x=Reduction, y=predicted_mc))
```



```{r}
#plot the abatement curve for antelope
ggplot(data=water_districts, aes(x=Reduction, y=MC_Antelope))+
  geom_point()+
  labs(x="Reduction",
        y= "Marginal Cost Of Abatement",
       title = "Cost of Abatement in Antelope County")+
  theme(legend.background= element_rect(fill= "light blue"))+
  theme(plot.background = element_rect(fill="azure2")) +
  theme(panel.background = element_rect(fill="aliceblue"))
```

```{r}
antelope_lm <- lm(MC_Antelope ~ 0 + Reduction, data=water_districts)
antelope_lm_tidy <- broom::tidy(antelope_lm)

antelope_lm
```
MC(A) for Antelope County = 2.858A

```{r}
#fitting line for antelope 
antelope_baseline <- 220
antelope_data <- tibble(Reduction = 0:150)
predicted_mc <- predict(antelope_lm, newdata=antelope_data)
antelope_data <- antelope_data %>% mutate(predicted_mc=predicted_mc)
```

```{r}
#plotting with predicted line 
ggplot(water_districts, aes(x=Reduction, y=MC_Antelope))+
  geom_point()+
  geom_line(data=antelope_data, aes(x=Reduction, y=predicted_mc))
```


```{r}
ggplot(data=water_districts, aes(x=Reduction, y=MC_Ventura))+
  geom_point()+
  labs(x="Reduction",
        y= "Marginal Cost Of Abatement",
       title = "Cost of Abatement in Ventura County")+
  theme(legend.background= element_rect(fill= "light blue"))+
  theme(plot.background = element_rect(fill="azure2")) +
  theme(panel.background = element_rect(fill="aliceblue"))
```
```{r}
ventura_lm <- lm(MC_Ventura ~ 0 + Reduction, data=water_districts)
ventura_lm_tidy <- broom::tidy(antelope_lm)

ventura_lm
```
MC(A) for Ventura County =1.776A

```{r}
#fitting line for Ventura
ventura_baseline <- 245
ventura_data <- tibble(Reduction = 0:150)
predicted_mc <- predict(ventura_lm, newdata=ventura_data)
ventura_data <- ventura_data %>% mutate(predicted_mc=predicted_mc)
```

```{r}
#plotting with predicted line 
ggplot(water_districts, aes(x=Reduction, y=MC_Ventura))+
  geom_point()+
  geom_line(data=ventura_data, aes(x=Reduction, y=predicted_mc))
```

2. Using your estimated marginal abatement cost curves, derive each district’s demand curve for water.In other words, how much would each district be willing to pay for the right to use the first AF of water,second AF, etc.? Plot each district’s demand curve on a single graph. Which sector is willing to pay the most for the first AF of water?

Kern County:
```{r}
#derive the demand curve for Kern County 
#define demand or use as baseline (no policy) - Abatement
kern_data <- kern_data %>% mutate(water_demand=kern_baseline-Reduction)
```

To calculate demand for Kern County:
P= 2.286(A) and A= E0-E, where E0=150 AF
P= 2.286(E0-E)
P= 2.286(150-E)
P= 342.9 - 2.286E

Marginal Demand for Kern County = 342.9 - 2.286E
```{r}
#plot the demand for Kern County
ggplot(kern_data, aes(x=water_demand,y=predicted_mc))+
  geom_line()
```

Mojave County:
```{r}
#derive demand curve for Mojave county
#define demand or use as baseline (no policy) - Abatement
mojave_data <- mojave_data %>% mutate(water_demand=mojave_baseline-Reduction)
```
-To calculate demand for Mojave County:
P= 3.804(A) and A= E0-E, where E0=140 AF
P= 3.804(E0-E)
P= 3.804(140-E)
P= 532.56 - 3.804E

```{r}
#plot the demand for Mojave County
ggplot(mojave_data, aes(x=water_demand,y=predicted_mc))+
  geom_line()
```

Antelope County:
```{r}
#derive demand curve for Antelope County
#define demand or use as baseline (no policy) - Abatement
antelope_data <- antelope_data %>% mutate(water_demand=antelope_baseline-Reduction)
```

To calculate demand for Antelope County:
P= 2.858(A) and A= E0-E, where E0=220 AF
P= 2.858(E0-E)
P= 2.858(220-E)
P= 628.76 - 2.858E

```{r}
#plot the demand curve for Antelope County
ggplot(antelope_data, aes(x=water_demand,y=predicted_mc))+
  geom_line()
```

Ventura County:
```{r}
#derive demand curve for Ventura County
#define demand or use as baseline (no policy) - Abatement
ventura_data <- ventura_data %>% mutate(water_demand=ventura_baseline-Reduction)
```

To calculate demand for Ventura County:
P= 1.776(A) and A= E0-E, where E0=245 AF
P= 1.776(E0-E)
P= 1.776(245-E)
P= 435.12 - 1.776E

```{r}
#plot the demand for Ventura County
ggplot(ventura_data, aes(x=water_demand,y=predicted_mc))+
  geom_line()
```


```{r}
#using demand data from Kern and Mojave, join into one data set for plotting 
joined_demand <- bind_rows("Mojave" = mojave_data,
                           "Kern" = kern_data, 
                           "Antelope" = antelope_data,
                           "Ventura" = ventura_data,
                           .id="Districts")


ggplot(data=joined_demand, aes(x=water_demand, y=predicted_mc))+
  geom_line(aes(color=Districts))

#this is what sandy did in office hours but it didnt work so I did a ggplot : plot(data = joined_demand, aes(x=water_demand, y=predicted_mc, color="Districts"))+ geom_line()
```


## How to Solve 3A
Here you will analyze three alternative policies for reducing water use among these irrigation districts.In total, these irrigation districts will need to reduce water consumption from the current 755 AF down to 500 AF. For each intervention listed below, perform the following calculations: (1) calculate the stringency of the policy (defined below for each intervention) required to achieve the 500 AF target, (2) calculate the total cost of meeting the target using that approach, (3) calculate the cost to each district, and (4) calculate the tax revenue generated.

a. Cap without trade. Reduce each district’s water use by the same fraction (e.g., 1/3 of current
baseline use), so the 500 AF target is met. Trade is not allowed. Stringency is defined as the
magnitude of the fraction.

- Using the baseline in each of the four cities, I set up an equation where the same fraction for each city times each city's baseline sums to 225. (225 is the amount of abatement that is needed (755-500))
- p*150 + p*145 + p*220 + p*245 = 255
- p=0.338
- Each city will reduce their water usage by 0.338 to achieve the policy 

b. Tax on water use. A single tax is implemented on all water use in each of the four districts, such that water use is reduced to the 500 AF target. Stringency is defined as the magnitude of the
tax.



c. Cap and trade. Cap water use as in part (a), but after those caps are set, allow trade across
districts. How much water is used by each district after trade? Stringency is the same as in part
(a).

```{r}
#calculate by hand
#baseline = c(150, 140, 220, 245)

#a single fraction multiplied by these numbers that sum to 755-500 = 225

#deductions <- function(p) {p*150+p*145+p*220+p*245 = 255}
#p= 0.338
#solve(deductions)
```
```{r}
#A function to compute the costs for a district's abatement given the abatement number
quantity_abate = 50
lm_mod=kern_lm

#defining function
calc_cost <- function(lm_mod, quantity_abate){
  estimated_cost = lm_mod$coefficients[1]*quantity_abate
  total_cost = 0.5 * quantity_abate * estimated_cost
  return(total_cost[[1]])
}

#what is the total cost of kern were to abate 117 unit?
calc_cost(kern_lm, quantity_abate = 117)

#Q3a Kern abated 
calc_cost(kern_lm, quantity_abate = 50.7)
```

